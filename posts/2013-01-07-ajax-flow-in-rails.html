<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="description" content="Takeshi Yaeda&#x27;s Blog"/><meta property="og:image" content="https://og-image.now.sh/yaeda.github.io.png?theme=light&amp;md=0&amp;fontSize=100px"/><meta name="og:title" content="yaeda.github.io"/><meta name="twitter:card" content="summary_large_image"/><title>Ajax Flow in Rails</title><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/76c8651640da223a821c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/76c8651640da223a821c.css" data-n-g=""/><link rel="preload" href="/_next/static/css/07b97ef93b5cc0911948.css" as="style"/><link rel="stylesheet" href="/_next/static/css/07b97ef93b5cc0911948.css" data-n-p=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-ceab71ff4af1e6f937e6.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.9ec1f7868b3e9d138cdd.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.cb82874e43d6dd0d0fae.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-09253b7f91a5d3536181.js" as="script"/><link rel="preload" href="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.ae55355a2d6373045c9b.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-1798ce9ce107015bcf0d.js" as="script"/></head><body><div id="__next"><div class="layout_container__2t4v2"><header class="layout_header__2rhWq"><p class="utils_headingMd__3de6G"><a class="utils_colorInherit__3Gudf" href="/">yaeda.github.io</a></p></header><main class="layout_main__26dVU"><article><h1 class="utils_headingXl__1XecN">Ajax Flow in Rails</h1><div class="utils_lightText__12Ckm"><time dateTime="2013-01-07 00:00">January 7, 2013</time><span> <!-- -->(<!-- -->almost 8 years ago<!-- -->)</span></div><div><p>ドットインストールのチュートリアルでブログシステムを作っているときに，ブログポストの削除リンクを以下のコードで実装した．</p>
<pre><code class="language-ruby">&#x3C;%= link_to 'Delete', post, :confirm => 'Sure?', :method => :delete, :remote => true %>
</code></pre>
<p>:confirm は確認用ダイアログのテキスト，:method はアクセスする HTTP メソッド，:remote は ajax アクセスするかしないか，の設定．</p>
<p>これは次のように展開される．</p>
<pre><code class="language-html">&#x3C;a href="/posts/1" data-confirm="Sure?" data-method="delete" rel="nofollow">Delete&#x3C;/a>
</code></pre>
<p>これだけではクリックしたら/post/1 に HTTP DELETE でアクセスするようにはならない．疑問が残ったので調べてみると，jquery_ujs.js というスクリプトで色々やっていた．</p>
<p>jquery_ujs.js は Gemfile で jquery-rails を設定していると直接読み込まれるようで，rails アプリケーションのディレクトリに見つけることは出来ない．私の環境だと~/.rbenv/versions/1.9.3-p194/lib/ruby/gems/1.9.1/gems/jquery-rails-2.1.4/vendor/assets/javascripts/jquery_ujs.js にあったが，Github のレポジトリ(rails/jquery-ujs · GitHub)か Developer Tools などで直接中身をみるのが早い．何故か圧縮されていないので簡単にコードを追うことができる．(因みに jquery 本体も圧縮されていない）</p>
<p>data-method については jquery_ujs.js の 185 行目の handleMethod 以下で，data-method に合わせて form を作って submit しているのが分かる．</p>
<p>ちなみに，jquery_ujs.js の 149 行目からの option の設定で，ajax が成功したときに ajax:success が trigger されることが分かる．ここまできてようやく以下のようにして結果を取得できることが分かる．(ここでは削除に成功した項目を fadeOut で消している)</p>
<pre><code class="language-js">$('a[data-method="delete"]').on("ajax:success", function (e, data, status, xhr) {
  $("#post_" + data.post.id).fadeOut("slow");
});
</code></pre>
<p>古いバージョンはちょっと話が違うようだが，Rails 3.2 では jquery が標準で利用できるようになっていて，jquery_ujs というライブラリで ajax 周りの実装が簡単に行うことができるようになっているのが分かった．Web Framework ってすげー．</p>
</div></article></main><div class="layout_backToHome__1vZsp"><a href="/">← Back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"2013-01-07-ajax-flow-in-rails","contentHtml":"\u003cp\u003eドットインストールのチュートリアルでブログシステムを作っているときに，ブログポストの削除リンクを以下のコードで実装した．\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-ruby\"\u003e\u0026#x3C;%= link_to 'Delete', post, :confirm =\u003e 'Sure?', :method =\u003e :delete, :remote =\u003e true %\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e:confirm は確認用ダイアログのテキスト，:method はアクセスする HTTP メソッド，:remote は ajax アクセスするかしないか，の設定．\u003c/p\u003e\n\u003cp\u003eこれは次のように展開される．\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-html\"\u003e\u0026#x3C;a href=\"/posts/1\" data-confirm=\"Sure?\" data-method=\"delete\" rel=\"nofollow\"\u003eDelete\u0026#x3C;/a\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eこれだけではクリックしたら/post/1 に HTTP DELETE でアクセスするようにはならない．疑問が残ったので調べてみると，jquery_ujs.js というスクリプトで色々やっていた．\u003c/p\u003e\n\u003cp\u003ejquery_ujs.js は Gemfile で jquery-rails を設定していると直接読み込まれるようで，rails アプリケーションのディレクトリに見つけることは出来ない．私の環境だと~/.rbenv/versions/1.9.3-p194/lib/ruby/gems/1.9.1/gems/jquery-rails-2.1.4/vendor/assets/javascripts/jquery_ujs.js にあったが，Github のレポジトリ(rails/jquery-ujs · GitHub)か Developer Tools などで直接中身をみるのが早い．何故か圧縮されていないので簡単にコードを追うことができる．(因みに jquery 本体も圧縮されていない）\u003c/p\u003e\n\u003cp\u003edata-method については jquery_ujs.js の 185 行目の handleMethod 以下で，data-method に合わせて form を作って submit しているのが分かる．\u003c/p\u003e\n\u003cp\u003eちなみに，jquery_ujs.js の 149 行目からの option の設定で，ajax が成功したときに ajax:success が trigger されることが分かる．ここまできてようやく以下のようにして結果を取得できることが分かる．(ここでは削除に成功した項目を fadeOut で消している)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-js\"\u003e$('a[data-method=\"delete\"]').on(\"ajax:success\", function (e, data, status, xhr) {\n  $(\"#post_\" + data.post.id).fadeOut(\"slow\");\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e古いバージョンはちょっと話が違うようだが，Rails 3.2 では jquery が標準で利用できるようになっていて，jquery_ujs というライブラリで ajax 周りの実装が簡単に行うことができるようになっているのが分かった．Web Framework ってすげー．\u003c/p\u003e\n","layout":"post","title":"Ajax Flow in Rails","date":"2013-01-07 00:00","comments":true,"categories":"rails ruby"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"2013-01-07-ajax-flow-in-rails"},"buildId":"RORhKcSLz6Skc9qlGei6v","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-11c8eba6a84e3fddec04.js"></script><script src="/_next/static/chunks/main-ceab71ff4af1e6f937e6.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.9ec1f7868b3e9d138cdd.js" async=""></script><script src="/_next/static/chunks/commons.cb82874e43d6dd0d0fae.js" async=""></script><script src="/_next/static/chunks/pages/_app-09253b7f91a5d3536181.js" async=""></script><script src="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.ae55355a2d6373045c9b.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-1798ce9ce107015bcf0d.js" async=""></script><script src="/_next/static/RORhKcSLz6Skc9qlGei6v/_buildManifest.js" async=""></script><script src="/_next/static/RORhKcSLz6Skc9qlGei6v/_ssgManifest.js" async=""></script></body></html>